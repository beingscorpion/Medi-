<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCQ</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(180deg, #f7f9ff 0%, #fdf6f2 100%);
            color: #0f172a;
        }
        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 12px 16px;
            margin: -16px -16px 16px -16px;
            display: flex;
            align-items: center;
        }
        .logo-link {
            display: flex;
            align-items: center;
            text-decoration: none;
        }
        .logo-img {
            height: 32px;
            width: auto;
        }
        .page {
            max-width: 440px;
            margin: 0 auto;
            padding: 16px 16px 48px;
        }
        .top-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .progress {
            font-weight: 700;
            color: #f97316;
        }
        .progress span {
            color: #94a3b8;
            font-weight: 600;
        }
        h1 {
            font-size: 22px;
            margin: 0 0 4px;
        }
        .subtitle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .subtitle {
            color: #94a3b8;
            font-size: 14px;
            margin: 0;
        }
        .report-icon {
            width: 20px;
            height: 20px;
            cursor: pointer;
            color: #94a3b8;
            transition: color 0.2s ease;
            flex-shrink: 0;
        }
        .report-icon:hover {
            color: #ef4444;
        }
        .card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.07);
            padding: 16px;
            margin-bottom: 16px;
        }
        .counter {
            font-size: 13px;
            color: #94a3b8;
            font-weight: 600;
        }
        .card h4 {
            color: #94a3b8;
            letter-spacing: 0.02em;
            font-size: 12px;
            margin: 0 0 10px;
            text-transform: uppercase;
        }
        .question-text {
            font-size: 16px;
            font-weight: 600;
            line-height: 1.5;
            color: #0f172a;
            margin-bottom: 16px;
        }
        .options {
            display: grid;
            gap: 10px;
        }
        .option {
            padding: 12px 14px;
            border-radius: 12px;
            background: #f8fafc;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            color: #0f172a;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .option:hover { transform: translateY(-1px); }
        .option.disabled {
            pointer-events: none;
            opacity: 0.9;
        }
        .option.correct {
            background: #dcfce7;
            border-color: #bbf7d0;
            color: #15803d;
        }
        .option.incorrect {
            background: #fee2e2;
            border-color: #fecdd3;
            color: #b91c1c;
        }
        .pill {
            width: 24px;
            height: 24px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .pill.correct { background: #22c55e; color: #fff; }
        .pill.incorrect { background: #ef4444; color: #fff; }
        .feedback {
            background: #fff7ed;
            border-radius: 16px;
            padding: 12px 16px 16px;
            border: 1px solid #fed7aa;
            display: none;
            gap: 4px;
        }
        .feedback h4 { color: #ea580c; }
        .feedback .answer {
            margin: 0 0 8px;
            font-weight: 700;
            color: #0f172a;
        }
        .explanation-title {
            color: #94a3b8;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.05em;
            margin: 12px 0 4px;
        }
        .explanation {
            margin: 0;
            color: #0f172a;
            line-height: 1.6;
            font-size: 14px;
        }
        .navigation-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
        }
        .nav-arrow {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            background: white;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 20px;
            flex-shrink: 0;
        }
        .nav-arrow:hover:not(:disabled) {
            border-color: #8b5cf6;
            color: #8b5cf6;
            background: #f5f3ff;
        }
        .nav-arrow:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .cta {
            flex: 1;
            display: flex;
            justify-content: center;
        }
        .cta button {
            width: 100%;
            padding: 16px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #5b21b6, #7c3aed);
            color: white;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(91, 33, 182, 0.35);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            opacity: 0.9;
        }
        .cta button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 12px 28px rgba(91, 33, 182, 0.45);
            opacity: 1;
        }
        .cta button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
    </style>
    <!-- MathJax for rendering mathematical expressions -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" defer></script>
</head>
<body>
    <div class="page">
        <div class="header">
            <a href="/dashboard/" class="logo-link">
                {% load static %}
                <img class="logo-img" src="{% static 'images/logo.svg' %}" alt="Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div style="display: none; align-items: center; gap: 8px; font-weight: 700; font-size: 1.25rem; color: #8b5cf6;">
                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #8b5cf6, #a855f7); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">M</div>
                    <span>MedSol</span>
                </div>
            </a>
        </div>
        
        <div class="top-bar">
            <div class="progress" id="progress-text">1<span>/1</span></div>
        </div>

        <h1 id="test-title">Practice Test</h1>
        <div class="subtitle-container">
            <div class="subtitle">Answer the below question</div>
            {% if user.is_authenticated %}
            <svg class="report-icon" id="report-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                <line x1="4" y1="22" x2="4" y2="15"></line>
            </svg>
            {% endif %}
        </div>

        <div class="card">
            <div class="counter" id="question-counter">Question 1</div>
            <div class="question-text" id="question-text"></div>

            <h4>Option</h4>
            <div class="options" id="options-container"></div>
        </div>

        <div class="feedback" id="feedback">
            <h4 id="feedback-title">Feedback</h4>
            <div class="answer" id="feedback-answer"></div>
            <div class="explanation-title">Explanation</div>
            <p class="explanation" id="feedback-explanation"></p>
        </div>

        <div class="navigation-container">
            <button class="nav-arrow" id="prev-btn" disabled>←</button>
            <div class="cta">
                <button type="button" id="next-btn" disabled>Next Question →</button>
            </div>
        </div>
    </div>

    <script>
        const questionData = JSON.parse('{{ questions_json|escapejs }}');
        const title = '{{ test_title|default:"Practice Test" }}';

        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedback = document.getElementById('feedback');
        const feedbackTitle = document.getElementById('feedback-title');
        const feedbackAnswer = document.getElementById('feedback-answer');
        const feedbackExplanation = document.getElementById('feedback-explanation');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const reportIcon = document.getElementById('report-icon');
        const progressText = document.getElementById('progress-text');
        const questionCounter = document.getElementById('question-counter');
        const testTitle = document.getElementById('test-title');

        let currentIndex = 0;
        let answered = false;
        let userAttempts = {}; // Store user attempts

        // Initialize userAttempts from questionData
        questionData.forEach(q => {
            if (q.selected) {
                userAttempts[q.id] = {
                    selected_text: q.selected,
                    is_correct: q.is_correct
                };
            }
        });

        testTitle.textContent = title;

        function updateNavigationState() {
            prevBtn.disabled = currentIndex === 0;
            // Next/Finish button is only enabled after answering
            if (!answered) {
                nextBtn.disabled = true;
            }
        }

        function renderQuestion() {
            const q = questionData[currentIndex];
            questionTextEl.innerHTML = q.question;
            questionCounter.textContent = `Question ${currentIndex + 1}`;
            progressText.innerHTML = `${currentIndex + 1}<span>/${questionData.length}</span>`;
            optionsContainer.innerHTML = '';

            // Check if user has a previous attempt for this question
            const previousAttempt = userAttempts[q.id] || (q.selected ? {
                selected_text: q.selected,
                is_correct: q.is_correct
            } : null);

            if (previousAttempt) {
                answered = true;
                feedback.style.display = 'block';
                nextBtn.disabled = false;
                nextBtn.textContent = (currentIndex === questionData.length - 1) ? 'Finish' : 'Next Question →';
            } else {
                answered = false;
                feedback.style.display = 'none';
                nextBtn.disabled = true;
            }

            q.options.forEach((opt) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.dataset.key = opt.key;
                div.innerHTML = `<span>${opt.label}</span>`;
                
                // Check if this option was previously selected
                const wasSelected = previousAttempt && previousAttempt.selected_text === opt.label;
                const isCorrect = opt.key === q.correct;
                
                if (previousAttempt) {
                    div.classList.add('disabled');
                    if (isCorrect) {
                        div.classList.add('correct');
                        const pill = document.createElement('span');
                        pill.className = 'pill correct';
                        pill.textContent = '✓';
                        div.appendChild(pill);
                    }
                    if (wasSelected && !isCorrect) {
                        div.classList.add('incorrect');
                        const pill = document.createElement('span');
                        pill.className = 'pill incorrect';
                        pill.textContent = '✕';
                        div.appendChild(pill);
                    }
                } else {
                    div.addEventListener('click', () => handleSelect(opt.key, opt.label));
                }
                
                optionsContainer.appendChild(div);
            });

            // Show feedback if there's a previous attempt
            if (previousAttempt) {
                if (previousAttempt.is_correct) {
                    feedbackTitle.textContent = 'Correct!';
                    feedbackAnswer.innerHTML = `You selected the right answer: ${q.options.find(o => o.key === q.correct).label}`;
                } else {
                    feedbackTitle.textContent = 'Wrong answer!';
                    const correctLabel = q.options.find(o => o.key === q.correct).label;
                    feedbackAnswer.innerHTML = `Correct Answer: ${correctLabel}`;
                }
                feedbackExplanation.innerHTML = q.explanation || 'Explanation not available.';
            }
            
            updateNavigationState();
            typesetMath();
        }

        function handleSelect(selectedKey, selectedText) {
            if (answered) return;
            answered = true;
            const q = questionData[currentIndex];
            const correctKey = q.correct;
            const isCorrect = selectedKey === correctKey;

            // Save attempt to database
            saveAttemptToDB(q.id, selectedText, isCorrect);

            // Store in local memory
            userAttempts[q.id] = {
                selected_text: selectedText,
                is_correct: isCorrect
            };

            optionsContainer.querySelectorAll('.option').forEach(opt => {
                const key = opt.dataset.key;
                opt.classList.add('disabled');
                if (key === correctKey) {
                    opt.classList.add('correct');
                    const pill = document.createElement('span');
                    pill.className = 'pill correct';
                    pill.textContent = '✓';
                    opt.appendChild(pill);
                }
                if (key === selectedKey && key !== correctKey) {
                    opt.classList.add('incorrect');
                    const pill = document.createElement('span');
                    pill.className = 'pill incorrect';
                    pill.textContent = '✕';
                    opt.appendChild(pill);
                }
            });

            if (isCorrect) {
                feedbackTitle.textContent = 'Correct!';
                feedbackAnswer.innerHTML = `You selected the right answer: ${q.options.find(o => o.key === correctKey).label}`;
            } else {
                feedbackTitle.textContent = 'Wrong answer!';
                const correctLabel = q.options.find(o => o.key === correctKey).label;
                feedbackAnswer.innerHTML = `Correct Answer: ${correctLabel}`;
            }
            feedbackExplanation.innerHTML = q.explanation || 'Explanation not available.';
            feedback.style.display = 'block';
            nextBtn.disabled = false;
            nextBtn.textContent = (currentIndex === questionData.length - 1) ? 'Finish' : 'Next Question →';
            updateNavigationState();
            typesetMath();
        }

        function saveAttemptToDB(questionId, selectedText, isCorrect) {
            {% if user.is_authenticated %}
            const formData = new FormData();
            formData.append('question_id', questionId);
            formData.append('selected_text', selectedText);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch('/api/save-attempt/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Failed to save attempt:', data.error);
                }
            })
            .catch(error => {
                console.error('Error saving attempt:', error);
            });
            {% else %}
            // User not authenticated, just store locally
            console.log('User not authenticated, attempt not saved to database');
            {% endif %}
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function goToNext() {
            if (currentIndex < questionData.length - 1) {
                currentIndex += 1;
                renderQuestion();
            } else {
                // If on last question, redirect to dashboard
                window.location.href = '/dashboard/';
            }
        }

        function goToPrev() {
            if (currentIndex > 0) {
                currentIndex -= 1;
                renderQuestion();
            }
        }

        nextBtn.addEventListener('click', goToNext);
        prevBtn.addEventListener('click', goToPrev);

        // Report icon click handler
        const reportIconEl = document.getElementById('report-icon');
        if (reportIconEl) {
            reportIconEl.addEventListener('click', () => {
                const currentQuestion = questionData[currentIndex];
                if (confirm('Do you want to report this question?')) {
                    reportQuestionToDB(currentQuestion.id);
                }
            });
        }

        function reportQuestionToDB(questionId) {
            const formData = new FormData();
            formData.append('question_id', questionId);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch('/api/report-question/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Question reported. Thank you for your feedback!');
                } else {
                    alert('Failed to report question: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error reporting question:', error);
                alert('An error occurred while reporting the question.');
            });
        }

        function typesetMath() {
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise();
            }
        }

        renderQuestion();
    </script>
</body>
</html>

